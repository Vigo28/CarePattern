<style>
    table {
        border-collapse: collapse;
    }

    td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
        vertical-align: top;
    }

    tr:nth-child(even) {
        background-color: #dddddd;
    }

    .prediction-content {
        text-decoration: none;
        color: inherit;
        white-space: pre-wrap;     /* preserve newlines and wrap long lines */
        display: inline-block;     /* allow block-level wrapping inside the anchor */
    }

    .progress {
        width: 180px;
        height: 12px;
        background: #eee;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
        display: inline-block;
        vertical-align: middle;
    }
    .fill {
        height: 100%;
        width: 0%;
        background: #2b8cff;
        transition: width 300ms;
        display: block;
    }
    .status-text {
        margin-left: 8px;
        display: inline-block;
        font-size: 0.9rem;
        vertical-align: middle;
    }
    .processing-indeterminate {
        width: 80px;
        height: 10px;
        background: linear-gradient(90deg, rgba(43,140,255,0) 0%, rgba(43,140,255,0.6) 50%, rgba(43,140,255,0) 100%);
        animation: ind 1s infinite linear;
        display: inline-block;
        border-radius: 5px;
        vertical-align: middle;
        margin-right: 8px;
    }
    @keyframes ind { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
</style>

<h2>Uploaded Files</h2>

{% if folders %}
    <table>
        <tr>
            <th>Original filename</th>
            <th>Raw video</th>
            <th>Video with skeleton overlay</th>
            <th>Skeleton overlay only</th>
            <th>Prediction</th>
            <th>Status</th>
        </tr>

        {% for folder in folders %}
            <tr id="row-{{ folder.name|e }}">
                <td>{{ folder.name }}</td>

                <td>
                    {% if folder.raw %}
                        <video width="320" height="180" controls>
                            <source src="{{ url_for('uploaded_file', filename=folder.raw) }}" type="video/mp4">
                            Your browser does not support HTML videos.
                        </video>
                    {% endif %}
                </td>

                <td>
                    {% if folder.overlay %}
                        <video width="320" height="180" controls>
                            <source src="{{ url_for('uploaded_file', filename=folder.overlay) }}" type="video/mp4">
                            Your browser does not support HTML videos.
                        </video>
                    {% endif %}
                </td>

                <td>
                    {% if folder.skeleton %}
                        <video width="320" height="180" controls>
                            <source src="{{ url_for('uploaded_file', filename=folder.skeleton) }}" type="video/mp4">
                            Your browser does not support HTML videos.
                        </video>
                    {% endif %}
                </td>

                <td>
                    {% if folder.prediction %}
                        <a href="{{ url_for('uploaded_file', filename=folder.prediction) }}" class="prediction-content">
                            {{ folder.prediction_content | e }}
                        </a>
                    {% endif %}
                </td>

                <td class="job-status" data-job-id="{{ folder.job_id }}">
                    {% if folder.job_id %}
                        <div class="status-inner">
                            <div class="processing-indeterminate" style="display:none" aria-hidden="true"></div>
                            <div class="progress" aria-hidden="true" style="display:none">
                                <span class="fill" style="width:0"></span>
                            </div>
                            <span class="status-text">Initializing…</span>
                        </div>
                    {% elif folder.overlay or folder.prediction %}
                        <span class="status-text">Done</span>
                    {% else %}
                        <span class="status-text">Waiting</span>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    </table>
{% else %}
    <p>No files uploaded</p>
{% endif %}

<script>
    (function(){
        const cells = Array.from(document.querySelectorAll('.job-status[data-job-id]')).filter(c => c.dataset.jobId);
        const timers = new Map();

        cells.forEach(cell => {
            const jobId = cell.dataset.jobId;
            const statusUrl = `/yolo/status/${jobId}`;

            async function updateOnce() {
                try {
                    const res = await fetch(statusUrl);
                    if (!res.ok) {
                        if (res.status === 404) {
                            const txt = cell.querySelector('.status-text');
                            const ind = cell.querySelector('.processing-indeterminate');
                            const prog = cell.querySelector('.progress');

                            if (txt) txt.textContent = 'Unknown';
                            if (ind) ind.style.display = 'none';
                            if (prog) prog.style.display = 'none';
                            clearInterval(timers.get(cell));
                            return;
                        }
                        throw new Error('status fetch failed');
                    }
                    const js = await res.json();

                    const hasProgress = Object.prototype.hasOwnProperty.call(js, 'progress') && js.progress !== null && js.progress !== undefined;
                    const p = hasProgress ? js.progress : 0;

                    const inner = cell.querySelector('.status-inner');
                    const fill = cell.querySelector('.fill');
                    const txt = inner ? inner.querySelector('.status-text') : null;
                    const ind = cell.querySelector('.processing-indeterminate');
                    const prog = cell.querySelector('.progress');

                    // If the polling UI doesn't exist (row replaced externally), stop.
                    if (!inner) {
                        clearInterval(timers.get(cell));
                        return;
                    }

                    // toggle indeterminate vs determinate bar
                    if (hasProgress) {
                        if (ind) ind.style.display = 'none';
                        if (prog) prog.style.display = 'inline-block';
                        if (fill) fill.style.width = p + '%';
                    } else {
                        if (ind) ind.style.display = 'inline-block';
                        if (prog) prog.style.display = 'none';
                    }

                    if (js.status === 'done') {
                        console.log('done');
                        if (txt) txt.textContent = 'Done';
                        if (ind) ind.style.display = 'none';
                        if (prog) prog.style.display = 'none';
                        // attempt to replace the finished row on the page
                        const row = cell.closest('tr');
                        const rowId = row ? row.id : null;
                        const attemptReplace = async () => {
                            try {
                                const r = await fetch(window.location.href, { cache: 'no-store' });
                                if (r.ok) {
                                    const text = await r.text();
                                    const parsed = new DOMParser().parseFromString(text, 'text/html');
                                    let newRow = rowId ? parsed.getElementById(rowId) : null;
                                    if (newRow) {
                                        const newStatusCell = newRow.querySelector('.job-status');
                                        if (newStatusCell && !newStatusCell.hasAttribute('data-job-id')) {
                                            row.parentNode.replaceChild(newRow, row);
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('row replacement failed', e);
                            }
                        };
                        setTimeout(attemptReplace, 600);
                        clearInterval(timers.get(cell));
                    } else if (js.status === 'error') {
                        if (txt) txt.textContent = `Error: ${js.error || 'processing error'}`;
                        if (ind) ind.style.display = 'none';
                        if (prog) prog.style.display = 'none';
                        clearInterval(timers.get(cell));
                    } else {
                        if (txt) txt.textContent = (hasProgress ? (p + '%') : 'Processing…');
                    }
                } catch (err) {
                    console.error('poll error', err);
                }
            }

            updateOnce();
            const tid = setInterval(updateOnce, 1500);
            timers.set(cell, tid);
        });

        window.addEventListener('beforeunload', () => {
            timers.forEach(tid => clearInterval(tid));
        });
    })();
</script>