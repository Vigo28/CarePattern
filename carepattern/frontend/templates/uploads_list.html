<style>
    table {
        border-collapse: collapse;
    }

    td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
        vertical-align: top;
    }

    tr:nth-child(even) {
        background-color: #dddddd;
    }

    .prediction-content {
        text-decoration: none;
        color: inherit;
        white-space: pre-wrap;     /* preserve newlines and wrap long lines */
        display: inline-block;     /* allow block-level wrapping inside the anchor */
    }

    .status-inner {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--gray-100);
        border-radius: 4px;
        width: 100%;
        max-width: 150px;
    }

    .progress {
        width: 100%;
        height: 6px;
        background: #eee;
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }
    .fill {
        height: 100%;
        width: 0%;
        background: #2b8cff;
        transition: width 300ms ease;
    }
    .progress-text {
        position: absolute;
        right: 0;
        top: -18px;
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    .status-text {
        color: var(--gray-900);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 500;
        text-align: center;
    }
    .status-done {
        background: #d1e7dd;
        color: #0f5132;
    }
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    .status-error {
        background: #f8d7da;
        color: #721c24;
    }
</style>

<div class="card">
    <div class="card-header">
        <h2>Analyseresultaten</h2>
        <p class="text-muted">Bekijk uw geüploade bewegingsanalyses</p>
    </div>

    {% if folders %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Patiënt Video</th>
                        <th>Originele Opname</th>
                        <th>Analyse Overlay</th>
                        <th>Bewegingspatroon</th>
                        <th>Resultaten</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for folder in folders %}
                        <tr id="row-{{ folder.name|e }}">
                            <td class="font-medium">{{ folder.name }}</td>
                            <td>
                                {% if folder.raw %}
                                    <div class="video-container">
                                        <video controls preload="metadata">
                                            <source src="{{ url_for('video', path=folder.raw) }}" type="video/mp4">
                                            Video kan niet worden weergegeven
                                        </video>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if folder.overlay %}
                                    <div class="video-container">
                                        <video controls preload="metadata">
                                            <source src="{{ url_for('video', path=folder.overlay) }}" type="video/mp4">
                                            Video kan niet worden weergegeven
                                        </video>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if folder.skeleton %}
                                    <div class="video-container">
                                        <video controls preload="metadata">
                                            <source src="{{ url_for('video', path=folder.skeleton) }}" type="video/mp4">
                                            Video kan niet worden weergegeven
                                        </video>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if folder.prediction_content %}
                                    <div class="analysis-results">
                                        {{ folder.prediction_content }}
                                    </div>
                                {% else %}
                                    <div class="text-muted">
                                        Geen resultaten beschikbaar
                                    </div>
                                {% endif %}
                            </td>
                            <!-- Update the status cell in the table -->
                            <td class="job-status" data-job-id="{{ folder.job_id }}">
                                {% if folder.overlay %}
                                    {% if folder.prediction %}
                                        <span class="status-badge status-done">Voltooid</span>
                                    {% else %}
                                        <span class="status-badge status-done">Geen resultaten</span>
                                    {% endif %}
                                {% elif folder.job_id %}
                                    <div class="status-inner">
                                        <div class="status-text">Bezig met verwerken</div>
                                        <div class="progress">
                                            <div class="fill"></div>
                                            <span class="progress-text">0%</span>
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="status-badge status-pending">In Afwachting</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            <p>Nog geen analyseresultaten beschikbaar</p>
            <a href="/upload" class="btn btn-primary mt-3">Start Nieuwe Analyse</a>
        </div>
    {% endif %}
</div>

<script>
(function(){
    const cells = document.querySelectorAll('.job-status[data-job-id]');
    const activeTimers = new Map();

    cells.forEach(cell => {
        const jobId = cell.dataset.jobId;
        if (!jobId) return;

        // Only start polling if the cell has a status-inner (active job)
        if (!cell.querySelector('.status-inner')) return;

        const statusUrl = `/yolo/status/${jobId}`;
        let completed = false;

        async function updateStatus() {
            try {
                const response = await fetch(statusUrl);
                if (!response.ok) throw new Error('Status fetch failed');
                
                const data = await response.json();
                const statusInner = cell.querySelector('.status-inner');
                if (!statusInner) {
                    stopPolling(jobId);
                    return;
                }

                const progressBar = statusInner.querySelector('.fill');
                const progressText = statusInner.querySelector('.progress-text');
                const statusText = statusInner.querySelector('.status-text');

                // Update progress
                if (data.progress !== null && data.progress !== undefined) {
                    const progress = Math.round(data.progress);
                    if (progressBar) progressBar.style.width = `${progress}%`;
                    if (progressText) progressText.textContent = `${progress}%`;
                }

                // Handle completion states
                if (data.status === 'done' && !completed) {
                    completed = true;
                    stopPolling(jobId);
                    setTimeout(() => window.location.reload(), 500);
                } else if (data.status === 'error') {
                    cell.innerHTML = '<span class="status-badge status-error">Fout bij verwerking</span>';
                    stopPolling(jobId);
                } else if (data.status && data.status !== 'processing') {
                    if (statusText) statusText.textContent = data.status;
                }
            } catch (error) {
                console.error('Status update error:', error);
                // Stop polling on error after 3 retries
                if (error.retries && error.retries >= 3) {
                    stopPolling(jobId);
                }
            }
        }

        function stopPolling(jobId) {
            const timer = activeTimers.get(jobId);
            if (timer) {
                clearInterval(timer);
                activeTimers.delete(jobId);
            }
        }

        // Initial update
        updateStatus();
        // Start polling and store the timer
        const timer = setInterval(updateStatus, 1000);
        activeTimers.set(jobId, timer);
    });

    // Cleanup timers when leaving the page
    window.addEventListener('beforeunload', () => {
        activeTimers.forEach(timer => clearInterval(timer));
        activeTimers.clear();
    });
})();
</script>